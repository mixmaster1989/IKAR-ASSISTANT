"""
üß† –ù–ï–ô–†–û–°–£–î - –ú–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å —Ä–∞–∑–Ω—ã–º–∏ AI –º–æ–¥–µ–ª—è–º–∏
–û—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –≥–ª—É–±–æ–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ –≥—Ä—É–ø–ø—ã
"""

import logging
import asyncio
from datetime import datetime, timedelta
from pathlib import Path
from typing import Dict, List, Any

logger = logging.getLogger("chatumba.neurosud")

class NeurosudAnalyzer:
    """–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –ù–ï–ô–†–û–°–£–î - –º–Ω–æ–≥–æ—ç—Ç–∞–ø–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Å —Ä–∞–∑–Ω—ã–º–∏ AI –º–æ–¥–µ–ª—è–º–∏"""
    
    def __init__(self):
        self.temp_dir = Path(__file__).parent.parent.parent / "temp"
        self.temp_dir.mkdir(exist_ok=True)
    
    async def analyze_group(self, chat_id: str) -> str:
        """
        –ü—Ä–æ–≤–æ–¥–∏—Ç –ø–æ–ª–Ω—ã–π –ù–ï–ô–†–û–°–£–î –∞–Ω–∞–ª–∏–∑ –≥—Ä—É–ø–ø—ã
        
        Args:
            chat_id: ID —á–∞—Ç–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
            
        Returns:
            str: –ü—É—Ç—å –∫ —Å–æ–∑–¥–∞–Ω–Ω–æ–º—É txt —Ñ–∞–π–ª—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
        """
        try:
            # –ò–º–ø–æ—Ä—Ç—ã
            from memory.sqlite import sqlite_storage
            from utils.component_manager import get_component_manager
            
            component_manager = get_component_manager()
            llm_client = component_manager.get_llm_client()
            
            logger.info(f"üß† –ù–ï–ô–†–û–°–£–î: –ù–∞—á–∏–Ω–∞—é –∞–Ω–∞–ª–∏–∑ –≥—Ä—É–ø–ø—ã {chat_id}")
            
            # 1. –°–æ–±–∏—Ä–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –≥—Ä—É–ø–ø—ã
            logger.info("üìÅ –°–æ–±–∏—Ä–∞—é –∏—Å—Ç–æ—Ä–∏—é –≥—Ä—É–ø–ø—ã...")
            
            # –ü–æ–ª—É—á–∞–µ–º –í–°–ï —Å–æ–æ–±—â–µ–Ω–∏—è –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞
            day_ago = int((datetime.now() - timedelta(days=1)).timestamp())
            messages = sqlite_storage.get_group_messages(chat_id)
            day_messages = []
            
            for msg in messages:
                try:
                    msg_timestamp = msg.get('timestamp', 0)
                    if isinstance(msg_timestamp, str):
                        msg_timestamp = int(msg_timestamp)
                    if msg_timestamp >= day_ago:
                        day_messages.append(msg)
                except:
                    continue
            
            if not day_messages:
                logger.warning("‚ö†Ô∏è –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞")
                return None
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∏—Å—Ç–æ—Ä–∏—é
            history_lines = []
            for msg in day_messages:
                content = msg.get('content', '').strip()
                if not content or content.startswith('/'):
                    continue
                
                user_id = msg.get('user_id', 'Unknown')
                name = sqlite_storage.get_group_user_name(chat_id, user_id) or f"User_{user_id[-4:]}"
                history_lines.append(f"{name}: {content}")
            
            history_text = "\n".join(history_lines)
            
            logger.info(f"üìä –°–æ–±—Ä–∞–Ω–æ {len(day_messages)} —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞")
            
            # 2. –ü–ï–†–í–ê–Ø –ü–û–ó–ò–¶–ò–Ø
            logger.info("üî• –§–æ—Ä–º–∏—Ä—É—é –ü–ï–†–í–£–Æ –ü–û–ó–ò–¶–ò–Æ...")
            
            first_prompt = f"""üéØ –¢—ã ‚Äî –ø–µ—Ä–≤—ã–π –æ–ø–ø–æ–Ω–µ–Ω—Ç –≤ –ù–ï–ô–†–û–°–£–î–ï! üí™

üìä –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ –∏ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –°–í–û–Æ –ü–û–ó–ò–¶–ò–Æ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–æ–≥–æ, —á—Ç–æ –≤–∏–¥–∏—à—å:
üîç ‚Äî –ö–∞–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã/–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ç—ã –∑–∞–º–µ—á–∞–µ—à—å?
üí° ‚Äî –ö–∞–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å?
üöÄ ‚Äî –ü–æ—á–µ–º—É –∏–º–µ–Ω–Ω–æ —Ç–≤–æ–π –ø–æ–¥—Ö–æ–¥ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π?

üìù –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, –±—É–¥—å —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–º –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º!

üí¨ –ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–ø–ø—ã:
{history_text}"""
            
            opinion_first = await llm_client.chat_completion(
                user_message=first_prompt,
                system_prompt="üé≠ –¢—ã –ø–µ—Ä–≤—ã–π –æ–ø–ø–æ–Ω–µ–Ω—Ç –≤ –¥–µ–±–∞—Ç–∞—Ö. –§–æ—Ä–º–∏—Ä—É–π –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏! üî•",
                temperature=0.7,
                max_tokens=1000
            )
            
            # 3. –í–¢–û–†–ê–Ø –ü–û–ó–ò–¶–ò–Ø
            logger.info("‚ö° –§–æ—Ä–º–∏—Ä—É—é –í–¢–û–†–£–Æ –ü–û–ó–ò–¶–ò–Æ...")
            
            second_prompt = f"""‚ö° –¢—ã ‚Äî –≤—Ç–æ—Ä–æ–π –æ–ø–ø–æ–Ω–µ–Ω—Ç –≤ –ù–ï–ô–†–û–°–£–î–ï! üé™

üîÑ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—É –∂–µ –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞, –Ω–æ —Å—Ñ–æ—Ä–º–∏—Ä—É–π –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–£–Æ –ü–û–ó–ò–¶–ò–Æ:
üéØ ‚Äî –ö–∞–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã –≤–∏–¥–∏—à—å –ø–æ-–¥—Ä—É–≥–æ–º—É?
üõ†Ô∏è ‚Äî –ö–∞–∫–æ–π –ø–æ–¥—Ö–æ–¥ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å —Ç—ã?
üí• ‚Äî –ü–æ—á–µ–º—É —Ç–≤–æ—è —Ç–æ—á–∫–∞ –∑—Ä–µ–Ω–∏—è –ª—É—á—à–µ?

üé® –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, –±—É–¥—å –∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–º –∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º!

üí¨ –ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–ø–ø—ã:
{history_text}"""
            
            opinion_second = await llm_client.chat_completion(
                user_message=second_prompt,
                system_prompt="üé™ –¢—ã –≤—Ç–æ—Ä–æ–π –æ–ø–ø–æ–Ω–µ–Ω—Ç –≤ –¥–µ–±–∞—Ç–∞—Ö. –ü—Ä–µ–¥–ª–∞–≥–∞–π –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É! –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏! ‚ö°",
                temperature=0.7,
                max_tokens=1000
            )
            
            # 4. –°–£–î–¨–Ø
            logger.info("‚öñÔ∏è –°—É–¥ –∏–¥—ë—Ç! –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –ø–æ–∑–∏—Ü–∏–∏...")
            
            judge_prompt = f"""‚öñÔ∏è –¢—ã ‚Äî —Ç—Ä–µ—Ç–µ–π—Å–∫–∏–π –ù–ï–ô–†–û–°–£–î–¨–Ø! üßë‚Äç‚öñÔ∏è

üîç –ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π –¥–≤–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã—Ö –º–Ω–µ–Ω–∏—è. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏—Ö:
üìä ‚Äî –°—Ä–∞–≤–Ω–∏ –ø–æ–∑–∏—Ü–∏–∏: —á—Ç–æ —Å–∏–ª—å–Ω–æ–≥–æ, —á—Ç–æ —Å–ª–∞–±–æ–≥–æ?
üí• ‚Äî –ì–¥–µ –∫—Ä–æ–µ—Ç—Å—è –≥–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç?
ü§ù ‚Äî –ö–∞–∫–æ–π –ø—É—Ç—å –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –æ–±–∞ –ø–æ–¥—Ö–æ–¥–∞?
üéØ ‚Äî –ß—Ç–æ –¥–µ–ª–∞—Ç—å –∫–æ–º–∞–Ω–¥–µ –ü–†–Ø–ú–û –°–ï–ô–ß–ê–°?

üé® –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –∏ –±—É–¥—å —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–º —Å—É–¥—å—ë–π!

üí¨ –ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–ø–ø—ã:
{history_text}

üî• –ü–µ—Ä–≤–∞—è –ø–æ–∑–∏—Ü–∏—è:
{opinion_first}

‚ö° –í—Ç–æ—Ä–∞—è –ø–æ–∑–∏—Ü–∏—è:
{opinion_second}"""
            
            judgement = await llm_client.chat_completion(
                user_message=judge_prompt,
                system_prompt="‚öñÔ∏è –¢—ã —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤—ã–π –Ω–µ–π—Ä–æ—Å—É–¥—å—è. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –æ–±—ä–µ–∫—Ç–∏–≤–Ω–æ! –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏! üßë‚Äç‚öñÔ∏è",
                temperature=0.6,
                max_tokens=1500
            )
            
            # 5. –ú–ï–¢–ê-–ù–ê–ë–õ–Æ–î–ê–¢–ï–õ–¨
            logger.info("üß† –ú–µ—Ç–∞-–∞–Ω–∞–ª–∏–∑ –æ—Ç –≤—ã—Å—à–µ–≥–æ —Ä–∞–∑—É–º–∞...")
            
            meta_prompt = f"""üß† –¢—ã ‚Äî –ú–ï–¢–ê-–ù–ê–ë–õ–Æ–î–ê–¢–ï–õ–¨! –í—ã—Å—à–∏–π —Ä–∞–∑—É–º! üåü

üîÆ –ü–æ–ª—É—á–∏ –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É –ø—Ä–æ–∏—Å—Ö–æ–¥—è—â–µ–≥–æ. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –í–°–Å:
üéØ ‚Äî –í—ã—Å–æ–∫–æ—É—Ä–æ–≤–Ω–µ–≤–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏
üîÑ ‚Äî –ö–∞–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –≤–∏–¥–∏—à—å –≤ –≥—Ä—É–ø–ø–µ?
üöß ‚Äî –ì–¥–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞ –∏ –ø—Ä–æ–±–ª–µ–º—ã?
üöÄ ‚Äî –ö–∞–∫—É—é –ì–õ–û–ë–ê–õ–¨–ù–£–Æ —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –≤—ã–±—Ä–∞—Ç—å?
üíé ‚Äî –ö–∞–∫–∏–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å?

üé® –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –∏ –¥–∞–π –º—É–¥—Ä—ã–π —Å–æ–≤–µ—Ç!

üí¨ –ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–ø–ø—ã:
{history_text}

üî• –ü–µ—Ä–≤–∞—è –ø–æ–∑–∏—Ü–∏—è:
{opinion_first}

‚ö° –í—Ç–æ—Ä–∞—è –ø–æ–∑–∏—Ü–∏—è:
{opinion_second}

‚öñÔ∏è –í–µ—Ä–¥–∏–∫—Ç —Å—É–¥—å–∏:
{judgement}"""
            
            meta_reflection = await llm_client.chat_completion(
                user_message=meta_prompt,
                system_prompt="üß† –¢—ã –º–µ—Ç–∞-–∞–Ω–∞–ª–∏—Ç–∏–∫ –≤—ã—Å—à–µ–≥–æ —É—Ä–æ–≤–Ω—è! –î–∞–π –≥–ª—É–±–æ–∫–∏–π –∞–Ω–∞–ª–∏–∑! –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏! üåü",
                temperature=0.5,
                max_tokens=2000
            )
            
            # 6. –°–æ–∑–¥–∞–µ–º txt —Ñ–∞–π–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"neurosud_analysis_{chat_id}_{timestamp}.txt"
            filepath = self.temp_dir / filename
            
            with open(filepath, 'w', encoding='utf-8') as f:
                f.write("üß† –ù–ï–ô–†–û–°–£–î - –ú–ù–û–ì–û–≠–¢–ê–ü–ù–´–ô –ê–ù–ê–õ–ò–ó –ì–†–£–ü–ü–´\n")
                f.write("=" * 60 + "\n\n")
                f.write(f"üìÖ –î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: {datetime.now().strftime('%d.%m.%Y %H:%M:%S')}\n")
                f.write(f"üí¨ –ì—Ä—É–ø–ø–∞: {chat_id}\n")
                f.write(f"üìä –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {len(day_messages)}\n")
                f.write(f"‚è∞ –ü–µ—Ä–∏–æ–¥: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 24 —á–∞—Å–∞\n\n")
                
                f.write("üî• –ü–ï–†–í–ê–Ø –ü–û–ó–ò–¶–ò–Ø:\n")
                f.write("-" * 30 + "\n")
                f.write(f"{opinion_first}\n\n")
                
                f.write("‚ö° –í–¢–û–†–ê–Ø –ü–û–ó–ò–¶–ò–Ø:\n")
                f.write("-" * 30 + "\n")
                f.write(f"{opinion_second}\n\n")
                
                f.write("‚öñÔ∏è –í–ï–†–î–ò–ö–¢ –°–£–î–¨–ò:\n")
                f.write("-" * 30 + "\n")
                f.write(f"{judgement}\n\n")
                
                f.write("üß† –ú–ï–¢–ê-–ê–ù–ê–õ–ò–ó:\n")
                f.write("-" * 30 + "\n")
                f.write(f"{meta_reflection}\n\n")
                
                f.write("=" * 60 + "\n")
                f.write("‚úÖ –ù–ï–ô–†–û–°–£–î –ó–ê–í–ï–†–®–Å–ù!\n")
            
            logger.info(f"‚úÖ –ù–ï–ô–†–û–°–£–î –∑–∞–≤–µ—Ä—à—ë–Ω! –§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω: {filepath}")
            return str(filepath)
            
        except Exception as e:
            logger.error(f"‚ùå –û—à–∏–±–∫–∞ –ù–ï–ô–†–û–°–£–î–ê: {e}")
            return None

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä
neurosud_analyzer = NeurosudAnalyzer()

async def run_neurosud_analysis(chat_id: str) -> str:
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ù–ï–ô–†–û–°–£–î –∞–Ω–∞–ª–∏–∑ –¥–ª—è –≥—Ä—É–ø–ø—ã"""
    return await neurosud_analyzer.analyze_group(chat_id)
