"""
–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è CRYPTOSUD –∞–Ω–∞–ª–∏–∑–∞.
–û—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö.
"""
import logging
import json
from typing import Dict, Any, Optional, List, Tuple
from datetime import datetime, timedelta

logger = logging.getLogger("chatumba.crypto.cryptosud")

# –ò–º–ø–æ—Ä—Ç—ã –∏–∑ –¥—Ä—É–≥–∏—Ö –º–æ–¥—É–ª–µ–π
from .detector import extract_trading_pair_from_description
from .data_fetcher import fetch_crypto_news, fetch_macro_economic_data, fetch_bingx_market_data, format_bingx_data_for_prompts, fetch_ultimate_crypto_data
from .analyzer import analyze_trading_chart

# –ò–º–ø–æ—Ä—Ç LLM –∫–ª–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ component manager
from backend.utils.component_manager import get_component_manager

component_manager = get_component_manager()
from backend.api.telegram import send_telegram_message, send_long_telegram_message


async def cryptosud_analysis(chat_id: str, 
                           image_description: str, 
                           crypto_terms: List[str],
                           detailed_chart_analysis: Optional[Dict] = None) -> str:
    """
    –ö–†–ò–ü–¢–û–°–£–î - —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏–∫–æ–≤ —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π BingX API.
    """
    try:
        # 1. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–ø—É—Å–∫–µ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
        await send_telegram_message(chat_id, "üö® –í–ù–ò–ú–ê–ù–ò–ï! –û–ë–ù–ê–†–£–ñ–ï–ù –ö–†–ò–ü–¢–û–ì–†–ê–§!", None)
        await send_telegram_message(chat_id, f"üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ç–µ—Ä–º–∏–Ω—ã: {', '.join(crypto_terms[:5])}", None)
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
        if detailed_chart_analysis:
            await send_telegram_message(chat_id, "üìä –°–ü–ï–¶–ò–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –ê–ù–ê–õ–ò–ó –ì–†–ê–§–ò–ö–ê –ü–û–õ–£–ß–ï–ù!", None)
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫—Ä–∞—Ç–∫—É—é –≤—ã–∂–∏–º–∫—É —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
            analysis_preview = detailed_chart_analysis[:300] + "..." if len(detailed_chart_analysis) > 300 else detailed_chart_analysis
            await send_telegram_message(chat_id, f"üìà –ö—Ä–∞—Ç–∫–∏–π –∞–Ω–∞–ª–∏–∑ –≥—Ä–∞—Ñ–∏–∫–∞:\n{analysis_preview}", None)
        else:
            await send_telegram_message(chat_id, "‚ö†Ô∏è –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Ä–∞–±–æ—Ç–∞—é —Å –±–∞–∑–æ–≤—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º", None)
        
        await send_telegram_message(chat_id, "‚öñÔ∏è –ó–ê–ü–£–°–ö–ê–ï–¢–°–Ø –ö–†–ò–ü–¢–û–°–£–î!", None)
        
        # 2. –û–ü–†–ï–î–ï–õ–Ø–ï–ú –¢–û–†–ì–û–í–£–Æ –ü–ê–†–£ –ò –ü–û–õ–£–ß–ê–ï–ú –î–ê–ù–ù–´–ï BINGX
        trading_pair = extract_trading_pair_from_description(image_description, crypto_terms)
        await send_telegram_message(chat_id, f"üéØ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ —Ç–æ—Ä–≥–æ–≤–∞—è –ø–∞—Ä–∞: {trading_pair}", None)
        
        # 2.1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ BingX API
        await send_telegram_message(chat_id, f"üì° –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ BingX API –¥–ª—è {trading_pair}...", None)
        bingx_data = await fetch_bingx_market_data(trading_pair)
        
        if "error" not in bingx_data:
            await send_telegram_message(chat_id, "‚úÖ BingX API –ø–æ–¥–∫–ª—é—á–µ–Ω! –ü–æ–ª—É—á–∞—é —Ä—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...", None)
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            ticker_info = ""
            if "ticker" in bingx_data and bingx_data["ticker"]:
                ticker_data = bingx_data["ticker"].get("data", {})
                if ticker_data and isinstance(ticker_data, dict):
                    price = ticker_data.get('lastPrice', 'N/A')
                    change = ticker_data.get('priceChangePercent', 'N/A')
                    ticker_info = f"üí∞ –¶–µ–Ω–∞: ${price} ({change}%)"
            
            if ticker_info:
                await send_telegram_message(chat_id, f"üìä {ticker_info}", None)
        else:
            await send_telegram_message(chat_id, "‚ö†Ô∏è BingX API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Ä–∞–±–æ—Ç–∞—é —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏", None)
        
        # 2.2. –ü–∞—Ä—Å–∏–Ω–≥ –∫—Ä–∏–ø—Ç–æ–Ω–æ–≤–æ—Å—Ç–µ–π –∏ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        await send_telegram_message(chat_id, "üì∞ –°–æ–±–∏—Ä–∞—é –ú–ê–ö–°–ò–ú–£–ú –¥–∞–Ω–Ω—ã—Ö –æ —Ä—ã–Ω–∫–µ...", None)
        crypto_news = await fetch_crypto_news(crypto_terms)
        
        # 2.3. –ü–æ–ª—É—á–∞–µ–º —É–ª—å—Ç–∏–º–µ–π—Ç –¥–∞–Ω–Ω—ã–µ
        await send_telegram_message(chat_id, "üöÄ –ü–æ–¥–∫–ª—é—á–∞—é 6 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö (Binance, CoinGecko, F&G Index...)...", None)
        ultimate_data = await fetch_ultimate_crypto_data(crypto_terms)
        
        # 2.4. –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ BingX –¥–ª—è –ø—Ä–æ–º–ø—Ç–æ–≤
        bingx_formatted = format_bingx_data_for_prompts(bingx_data)
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
        full_market_data = f"{crypto_news}\n\nüî• –†–ê–°–®–ò–†–ï–ù–ù–´–ï –î–ê–ù–ù–´–ï:\n{ultimate_data}\n\n{bingx_formatted}"
        
        await send_telegram_message(chat_id, "‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–±—Ä–∞–Ω—ã! –ù–∞—á–∏–Ω–∞—é –∞–Ω–∞–ª–∏–∑ —ç–∫—Å–ø–µ—Ä—Ç–æ–≤...", None)
        
        # 3. –ë–´–ß–ò–ô –ê–ù–ê–õ–ò–¢–ò–ö
        await send_telegram_message(chat_id, "üêÇ –§–æ—Ä–º–∏—Ä—É—é –ë–´–ß–¨–Æ –ø–æ–∑–∏—Ü–∏—é...", None)
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞
        full_chart_description = image_description
        if detailed_chart_analysis:
            full_chart_description += f"\n\nüìä –î–ï–¢–ê–õ–¨–ù–´–ô –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó:\n{detailed_chart_analysis}"
        
        bull_prompt = f"""üêÇ –¢—ã ‚Äî –ë–´–ß–ò–ô –ö–†–ò–ü–¢–û–ê–ù–ê–õ–ò–¢–ò–ö! –û–ø—Ç–∏–º–∏—Å—Ç –∏ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–∫ —Ä–æ—Å—Ç–∞! üìà

üéØ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≥—Ä–∞—Ñ–∏–∫ –∏ —Ä—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –ë–´–ß–¨–ï–ô –ø–æ–∑–∏—Ü–∏–∏:
üíö ‚Äî –ö–∞–∫–∏–µ —Å–∏–≥–Ω–∞–ª—ã —Ä–æ—Å—Ç–∞ —Ç—ã –≤–∏–¥–∏—à—å?
üöÄ ‚Äî –ü–æ—á–µ–º—É —Ü–µ–Ω–∞ –ø–æ–π–¥–µ—Ç –í–í–ï–†–•?
üíé ‚Äî –ö–∞–∫–∏–µ —É—Ä–æ–≤–Ω–∏ –¥–ª—è –ø–æ–∫—É–ø–∫–∏?
üìä ‚Äî –¢–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è?

üé® –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, –±—É–¥—å —É–±–µ–¥–∏—Ç–µ–ª—å–Ω—ã–º –±—ã–∫–æ–º! üêÇ

üì∑ –ê–Ω–∞–ª–∏–∑ –≥—Ä–∞—Ñ–∏–∫–∞:
{full_chart_description}

üì∞ –†—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
{full_market_data}

‚ö†Ô∏è –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ BingX API –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–≤–æ–∏—Ö –≤—ã–≤–æ–¥–æ–≤!"""
        
        bull_opinion = await component_manager.get_llm_client().chat_completion(
            user_message=bull_prompt,
            system_prompt="üêÇ –¢—ã –±—ã—á–∏–π –∫—Ä–∏–ø—Ç–æ–∞–Ω–∞–ª–∏—Ç–∏–∫! –ò—â–∏ —Å–∏–≥–Ω–∞–ª—ã —Ä–æ—Å—Ç–∞! –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏! üìà",
            chat_history=[],
            max_tokens=1000
        )
        
        await send_telegram_message(chat_id, "üêÇ –ë—ã—á–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∞–Ω–∞–ª–∏–∑!", None)
        await send_long_telegram_message(chat_id, f"üêÇ **–ë–´–ß–¨–Ø –ü–û–ó–ò–¶–ò–Ø:**\n{bull_opinion}", None)
        
        # 4. –ú–ï–î–í–ï–ñ–ò–ô –ê–ù–ê–õ–ò–¢–ò–ö
        await send_telegram_message(chat_id, "üêª –§–æ—Ä–º–∏—Ä—É—é –ú–ï–î–í–ï–ñ–¨–Æ –ø–æ–∑–∏—Ü–∏—é...", None)
        
        bear_prompt = f"""üêª –¢—ã ‚Äî –ú–ï–î–í–ï–ñ–ò–ô –ö–†–ò–ü–¢–û–ê–ù–ê–õ–ò–¢–ò–ö! –†–µ–∞–ª–∏—Å—Ç –∏ —Å–∫–µ–ø—Ç–∏–∫! üìâ

üéØ –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –≥—Ä–∞—Ñ–∏–∫ –∏ —Ä—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –ú–ï–î–í–ï–ñ–¨–ï–ô –ø–æ–∑–∏—Ü–∏–∏:
‚ù§Ô∏è ‚Äî –ö–∞–∫–∏–µ —Å–∏–≥–Ω–∞–ª—ã –ø–∞–¥–µ–Ω–∏—è —Ç—ã –≤–∏–¥–∏—à—å?
üìâ ‚Äî –ü–æ—á–µ–º—É —Ü–µ–Ω–∞ –ø–æ–π–¥–µ—Ç –í–ù–ò–ó?
üí∏ ‚Äî –ö–∞–∫–∏–µ —Ä–∏—Å–∫–∏ –∏ –æ–ø–∞—Å–Ω–æ—Å—Ç–∏?
üìä ‚Äî –¢–≤–æ–π –ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ü–∏—é?

üé® –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, –±—É–¥—å –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã–º –º–µ–¥–≤–µ–¥–µ–º! üêª

üì∑ –ê–Ω–∞–ª–∏–∑ –≥—Ä–∞—Ñ–∏–∫–∞:
{full_chart_description}

üì∞ –†—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
{full_market_data}

‚ö†Ô∏è –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ BingX API –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å–≤–æ–∏—Ö –≤—ã–≤–æ–¥–æ–≤!"""
        
        bear_opinion = await component_manager.get_llm_client().chat_completion(
            user_message=bear_prompt,
            system_prompt="üêª –¢—ã –º–µ–¥–≤–µ–∂–∏–π –∫—Ä–∏–ø—Ç–æ–∞–Ω–∞–ª–∏—Ç–∏–∫! –ò—â–∏ —Ä–∏—Å–∫–∏ –∏ —Å–∏–≥–Ω–∞–ª—ã –ø–∞–¥–µ–Ω–∏—è! –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏! üìâ",
            chat_history=[],
            max_tokens=1000
        )
        
        await send_telegram_message(chat_id, "üêª –ú–µ–¥–≤–µ–∂–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫ –∑–∞–≤–µ—Ä—à–∏–ª –∞–Ω–∞–ª–∏–∑!", None)
        await send_long_telegram_message(chat_id, f"üêª **–ú–ï–î–í–ï–ñ–¨–Ø –ü–û–ó–ò–¶–ò–Ø:**\n{bear_opinion}", None)
        
        # 5. –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –°–£–î–¨–Ø
        await send_telegram_message(chat_id, "üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ –æ—Ç —Å—É–¥—å–∏...", None)
        
        tech_prompt = f"""üìä –¢—ã ‚Äî –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–¢–ò–ö-–°–£–î–¨–Ø! –û–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç! ‚öñÔ∏è

üîç –ü–µ—Ä–µ–¥ —Ç–æ–±–æ–π –¥–≤–∞ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω—ã—Ö –º–Ω–µ–Ω–∏—è. –î–∞–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –æ—Ü–µ–Ω–∫—É:
üìà ‚Äî –ö–∞–∫–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–∏–≥–Ω–∞–ª—ã —Å–∏–ª—å–Ω–µ–µ?
‚öñÔ∏è ‚Äî –ß—Ç–æ –≥–æ–≤–æ—Ä—è—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã –∏ –ø–∞—Ç—Ç–µ—Ä–Ω—ã?
üéØ ‚Äî –ö–ª—é—á–µ–≤—ã–µ —É—Ä–æ–≤–Ω–∏ –∏ –∑–æ–Ω—ã?
üìä ‚Äî –û–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–≥–Ω–æ–∑?

üé® –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –∏ –±—É–¥—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º —ç–∫—Å–ø–µ—Ä—Ç–æ–º! üìä

üì∑ –û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞:
{image_description}

üêÇ –ë—ã—á—å–µ –º–Ω–µ–Ω–∏–µ:
{bull_opinion}

üêª –ú–µ–¥–≤–µ–∂—å–µ –º–Ω–µ–Ω–∏–µ:
{bear_opinion}

üì∞ –†—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
{full_market_data}

‚ö†Ô∏è –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ BingX API –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —É—Ä–æ–≤–Ω–µ–π!"""
        
        tech_analysis = await component_manager.get_llm_client().chat_completion(
            user_message=tech_prompt,
            system_prompt="üìä –¢—ã —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫-—Å—É–¥—å—è! –û–±—ä–µ–∫—Ç–∏–≤–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≥—Ä–∞—Ñ–∏–∫–æ–≤! –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏! ‚öñÔ∏è",
            chat_history=[],
            max_tokens=20000  # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–æ 20K —Ç–æ–∫–µ–Ω–æ–≤!
        )
        
        await send_telegram_message(chat_id, "üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—É–¥—å—è –≤—ã–Ω–µ—Å –≤–µ—Ä–¥–∏–∫—Ç!", None)
        await send_long_telegram_message(chat_id, f"üìä **–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ô –ê–ù–ê–õ–ò–ó:**\n{tech_analysis}", None)
        
        # 6. –ú–ê–ö–†–û–≠–ö–û–ù–û–ú–ò–ß–ï–°–ö–ò–ô –≠–ö–°–ü–ï–†–¢
        await send_telegram_message(chat_id, "üåç –°–æ–±–∏—Ä–∞—é –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ...", None)
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–µ –º–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
        macro_economic_data = await fetch_macro_economic_data()
        
        await send_telegram_message(chat_id, "üåç –ú–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑...", None)
        
        current_date = datetime.now().strftime("%d.%m.%Y")
        current_year = datetime.now().year
        
        macro_prompt = f"""üåç –¢—ã ‚Äî –ú–ê–ö–†–û–≠–ö–û–ù–û–ú–ò–ß–ï–°–ö–ò–ô –≠–ö–°–ü–ï–†–¢! –í–∏–¥–∏—à—å –±–æ–ª—å—à—É—é –∫–∞—Ä—Ç–∏–Ω—É! üîÆ

‚ö†Ô∏è –í–ê–ñ–ù–û: –°–ï–ì–û–î–ù–Ø {current_date} ({current_year} –≥–æ–¥). –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å —É—á–µ—Ç–æ–º –¢–ï–ö–£–©–ï–ì–û –≤—Ä–µ–º–µ–Ω–∏!

üåê –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–∏—Ç—É–∞—Ü–∏—é —Å –≤—ã—Å–æ—Ç—ã –º–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫–∏:
üí∞ ‚Äî –ö–∞–∫ —Ç–µ–∫—É—â–∞—è –º–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏–∫–∞ –≤–ª–∏—è–µ—Ç –Ω–∞ –∫—Ä–∏–ø—Ç—É –≤ {current_year} –≥–æ–¥—É?
üè¶ ‚Äî –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–º–∏ —Ä—ã–Ω–∫–∞–º–∏ –°–ï–ô–ß–ê–°?
üìà ‚Äî –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã –∏ —Ü–∏–∫–ª—ã (—É—á–∏—Ç—ã–≤–∞–π —Ö–∞–ª–≤–∏–Ω–≥ 2024, ETF –æ–¥–æ–±—Ä–µ–Ω–∏—è)?
üéØ ‚Äî –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ 6-12 –º–µ—Å—è—Ü–µ–≤?
üîÆ ‚Äî –ì–¥–µ –º—ã –Ω–∞—Ö–æ–¥–∏–º—Å—è –≤ 4-–ª–µ—Ç–Ω–µ–º —Ü–∏–∫–ª–µ Bitcoin?

üé® –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –∏ –¥–∞–π –º—É–¥—Ä—ã–π –º–∞–∫—Ä–æ—Å–æ–≤–µ—Ç! üåç

üìÖ –ê–ö–¢–£–ê–õ–¨–ù–´–ï –ú–ê–ö–†–û–î–ê–ù–ù–´–ï ({current_date}):
{macro_economic_data}

üì∑ –û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–∞:
{image_description}

üêÇ –ë—ã—á—å–µ –º–Ω–µ–Ω–∏–µ:
{bull_opinion}

üêª –ú–µ–¥–≤–µ–∂—å–µ –º–Ω–µ–Ω–∏–µ:
{bear_opinion}

üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑:
{tech_analysis}

üì∞ –†—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:
{full_market_data}

‚ö†Ô∏è –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –¥–∞–Ω–Ω—ã–µ BingX API –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ä—ã–Ω–∫–∞!"""
        
        macro_analysis = await component_manager.get_llm_client().chat_completion(
            user_message=macro_prompt,
            system_prompt=f"üåç –¢—ã –º–∞–∫—Ä–æ—ç–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π —ç–∫—Å–ø–µ—Ä—Ç! –°–ï–ì–û–î–ù–Ø {current_date} ({current_year} –≥–æ–¥)! –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å —É—á–µ—Ç–æ–º –¢–ï–ö–£–©–ï–ì–û –≤—Ä–µ–º–µ–Ω–∏ –∏ —Ü–∏–∫–ª–æ–≤! –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏! üîÆ",
            chat_history=[],
            max_tokens=2000
        )
        
        await send_telegram_message(chat_id, "üåç –ú–∞–∫—Ä–æ—ç–∫—Å–ø–µ—Ä—Ç –∑–∞–≤–µ—Ä—à–∏–ª –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑!", None)
        await send_long_telegram_message(chat_id, f"üåç **–ú–ê–ö–†–û–ê–ù–ê–õ–ò–ó:**\n{macro_analysis}", None)
        
        # 7. –¢–û–†–ì–û–í–´–ô –°–ò–ì–ù–ê–õ - –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–î–ï–õ–ö–ê
        await send_telegram_message(chat_id, "üí∞ –§–æ—Ä–º–∏—Ä—É—é —Ç–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª...", None)
        
        trading_prompt = f"""üí∞ –¢—ã ‚Äî –ü–†–û–§–ï–°–°–ò–û–ù–ê–õ–¨–ù–´–ô –¢–†–ï–ô–î–ï–†-–ê–ù–ê–õ–ò–¢–ò–ö! –≠–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç–æ—Ä–≥–æ–≤—ã–º —Å–∏–≥–Ω–∞–ª–∞–º! üìä

üéØ –ù–∞ –æ—Å–Ω–æ–≤–µ –í–°–ï–• –∞–Ω–∞–ª–∏–∑–æ–≤ –≤—ã—à–µ, –¥–∞–π –ß–ï–¢–ö–£–Æ –¢–û–†–ì–û–í–£–Æ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Æ:

üìà **–ù–ê–ü–†–ê–í–õ–ï–ù–ò–ï:** LONG/SHORT/–û–ñ–ò–î–ê–ù–ò–ï
üíµ **–¶–ï–ù–ê –í–•–û–î–ê:** –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ü–µ–Ω–∞ –∏–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω
üéØ **TAKE PROFIT:** –¶–µ–ª–µ–≤—ã–µ —É—Ä–æ–≤–Ω–∏ (1-3 —Ü–µ–ª–∏)
üõë **STOP LOSS:** –£—Ä–æ–≤–µ–Ω—å —Å—Ç–æ–ø-–ª–æ—Å—Å–∞
‚è∞ **–¢–ê–ô–ú–§–†–ï–ô–ú:** –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω–æ/—Å—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω–æ/–¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ
üìä **–†–ê–ó–ú–ï–† –ü–û–ó–ò–¶–ò–ò:** % –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞
‚öñÔ∏è **–†–ò–°–ö/–ü–†–ò–ë–´–õ–¨:** –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ R/R

üî• –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º! –ù–∏–∫–∞–∫–∏—Ö "–≤–æ–∑–º–æ–∂–Ω–æ" –∏ "–º–æ–∂–µ—Ç –±—ã—Ç—å"!

üì∑ –ì—Ä–∞—Ñ–∏–∫: {image_description}

üêÇ –ë—ã—á–∏–π –∞–Ω–∞–ª–∏–∑: {bull_opinion}

üêª –ú–µ–¥–≤–µ–∂–∏–π –∞–Ω–∞–ª–∏–∑: {bear_opinion}

üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑: {tech_analysis}

üåç –ú–∞–∫—Ä–æ–∞–Ω–∞–ª–∏–∑: {macro_analysis}

üì∞ –†—ã–Ω–æ—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ: {full_market_data}"""
        
        trading_signal = await component_manager.get_llm_client().chat_completion(
            user_message=trading_prompt,
            system_prompt="üí∞ –¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä! –î–∞–≤–∞–π —á–µ—Ç–∫–∏–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã! –ù–∏–∫–∞–∫–∏—Ö —Ä–∞–∑–º—ã—Ç—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫! üìä",
            chat_history=[],
            max_tokens=1000
        )
        
        await send_telegram_message(chat_id, "üí∞ –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω!", None)
        await send_long_telegram_message(chat_id, f"üí∞ **–¢–û–†–ì–û–í–´–ô –°–ò–ì–ù–ê–õ:**\n{trading_signal}", None)
        
        # –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        await send_telegram_message(chat_id, "‚úÖ –ö–†–ò–ü–¢–û–°–£–î –ó–ê–í–ï–†–®–Å–ù! üéâ –¢–æ—Ä–≥–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª –≥–æ—Ç–æ–≤! üí∞", None)
        
        logger.info(f"[–ö–†–ò–ü–¢–û–°–£–î] –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω –¥–ª—è –≥—Ä—É–ø–ø—ã {chat_id}")
        
        return "‚úÖ –ö–†–ò–ü–¢–û–°–£–î –ó–ê–í–ï–†–®–Å–ù! üéâ"
        
    except Exception as e:
        logger.error(f"[–ö–†–ò–ü–¢–û–°–£–î] –û—à–∏–±–∫–∞: {e}")
        await send_telegram_message(chat_id, f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ö–†–ò–ü–¢–û–°–£–î–ê: {e}", None)
        return f"‚ùå –û—à–∏–±–∫–∞ –ö–†–ò–ü–¢–û–°–£–î–ê: {e}"


# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
cryptosud_analyzer = None  # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
