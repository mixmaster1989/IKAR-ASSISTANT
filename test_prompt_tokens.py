#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
"""

import sys
import os
sys.path.append('/root/IKAR-ASSISTANT')

from backend.api.smart_bot_trigger import SmartBotTrigger
from backend.core.memory_injector import MemoryInjector
import asyncio
import json
from datetime import datetime

async def test_prompt_tokens():
    """–¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–æ–≤"""
    
    # –°–æ–∑–¥–∞—ë–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Ç—Ä–∏–≥–≥–µ—Ä–∞
    trigger = SmartBotTrigger()
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    test_context = {
        'trigger_message': '–ö–∞–∫ –¥–æ–±—Ä–∞—Ç—å—Å—è –¥–æ –æ—Ñ–∏—Å–∞ –Ω–∞ –®–µ–≤—á–µ–Ω–∫–æ 76?',
        'chat_id': '-1002805903176',
        'user_id': 'test_user',
        'dialogue_context': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø—Ä–æ –º–∞—Ä—à—Ä—É—Ç –¥–æ –æ—Ñ–∏—Å–∞'
    }
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
    time_info = trigger._memory_manager.get_current_time_info()
    system_prompt = trigger._build_system_prompt(
        time_info=time_info,
        recent_responses=[],
        current_topic="–º–∞—Ä—à—Ä—É—Ç –¥–æ –æ—Ñ–∏—Å–∞"
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç
    user_message = f"""–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª: "{test_context['trigger_message']}"

–¢–µ–∫—É—â–∞—è —Ç–µ–º–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞: –º–∞—Ä—à—Ä—É—Ç –¥–æ –æ—Ñ–∏—Å–∞

–¢–µ—Å—Ç–æ–≤–∞—è –ø–∞–º—è—Ç—å –æ –∫–æ–º–ø–∞–Ω–∏–∏ –ò–ö–ê–†

=== –ü–û–°–õ–ï–î–ù–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø ===
–¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞

{test_context['dialogue_context']}

–í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –µ—Å—Ç—å –ø—Ä–æ—Å—å–±–∞ –Ω–∞—Ä–∏—Å–æ–≤–∞—Ç—å —á—Ç–æ-—Ç–æ –∏–ª–∏ —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞, –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–±–∞–≤—å –≤ –∫–æ–Ω–µ—Ü –æ—Ç–≤–µ—Ç–∞ JSON —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.

üé¨ –≠–ú–û–¶–ò–û–ù–ê–õ–¨–ù–´–ï –í–ò–î–ï–û (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û):
–í –ö–ê–ñ–î–û–ú –û–¢–í–ï–¢–ï –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–æ–±–∞–≤–ª—è–π JSON —Å –≤—ã–±–æ—Ä–æ–º mp4-—Ñ–∞–π–ª–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ. –í—ã–±–∏—Ä–∞–π —Å–∞–º–æ–µ —É–º–µ—Å—Ç–Ω–æ–µ –≤–∏–¥–µ–æ –ø–æ–¥ —Å–∏—Ç—É–∞—Ü–∏—é (–µ—Å–ª–∏ —Å–æ–º–Ω–µ–≤–∞–µ—à—å—Å—è ‚Äî –≤–æ–∑—å–º–∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ). –ù–∞ –≤—Å–µ—Ö –≤–∏–¥–µ–æ –∏–∑–æ–±—Ä–∞–∂—ë–Ω —Ç—ã, –≤ —Å–º–æ–∫–∏–Ω–≥–µ, –ø—Ä–∏ –ø–æ–ª–Ω–æ–º –ø–∞—Ä–∞–¥–µ. –í–ê–ñ–ù–û: –∏–º—è –≤ JSON –¥–æ–ª–∂–Ω–æ –¢–û–ß–ù–û —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞ –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞ emotion/.
–î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–∏–¥–µ–æ (–¢–û–ß–ù–´–ï –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤):
- "–î–æ–±—Ä—ã–π –¥–µ–Ω—å.mp4" ‚Äî –¥–ª—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
- "–ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç.mp4" ‚Äî –¥–ª—è –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è –∫ –¥–µ–π—Å—Ç–≤–∏—é
- "–í–¥–æ—Ö–Ω–æ–≤–µ–Ω–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç(—É–∫–∞–∑—ã–≤–∞–µ—Ç —Ä—É–∫–∞–º–∏ –Ω–∞ —á—Ç–æ-–ª–∏–±–æ).mp4" ‚Äî –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è –Ω–∞ –≤–∞–∂–Ω–æ–µ
- "—É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—å–Ω–æ–µ –¥–∞.mp4" ‚Äî –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- "–Ω–µ —Å–æ–º–Ω–µ–≤–∞–π—Ç–µ—Å—å.mp4" ‚Äî –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏
- "–£–º–µ—Å—Ç–Ω–æ –∫–æ–≥–¥–∞ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ—à–µ–Ω–∏–µ.mp4" ‚Äî –∫–æ–≥–¥–∞ –Ω–∞–π–¥–µ–Ω–æ —Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
- "—Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω–æ –∂–¥–µ—Ç.mp4" ‚Äî –∫–æ–≥–¥–∞ –∂–¥—ë—à—å –æ—Ç–≤–µ—Ç–∞
- "–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—Ç.mp4" ‚Äî –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π –∏–ª–∏ –ø—Ä–æ—Å—å–±—ã –Ω–µ –ø–∞–Ω–∏–∫–æ–≤–∞—Ç—å

–í –ö–û–ù–ï–¶ –ö–ê–ñ–î–û–ì–û –û–¢–í–ï–¢–ê –¥–æ–±–∞–≤–ª—è–π JSON:
```json
{{"emotion_video": "–¢–û–ß–ù–û–ï_–ò–ú–Ø_–ò–ó_–°–ü–ò–°–ö–ê.mp4"}}
```

üöó –ü–û–ö–ê–ó –î–û–†–û–ì–ò –î–û –û–§–ò–°–ê (–®–ï–í–ß–ï–ù–ö–û, 76) ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û:
–ï—Å–ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏—è—Ö –µ—Å—Ç—å –õ–Æ–ë–û–ï —É–ø–æ–º–∏–Ω–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –ø—É—Ç–∏/–º–∞—Ä—à—Ä—É—Ç–∞/–¥–æ—Ä–æ–≥–∏/–∫–∞–∫ –ø—Ä–æ–π—Ç–∏/–∞–¥—Ä–µ—Å–∞ –æ—Ñ–∏—Å–∞/¬´–®–µ–≤—á–µ–Ω–∫–æ 76¬ª, –¢–´ –û–ë–Ø–ó–ê–ù –≤ –ö–û–ù–ï–¶ –æ—Ç–≤–µ—Ç–∞ –î–û–ë–ê–í–ò–¢–¨ –æ—Ç–¥–µ–ª—å–Ω—ã–º markdown-–±–ª–æ–∫–æ–º JSON:
```json
{{"showroad": true}}
```
–≠—Ç–æ –¢–†–ï–ë–û–í–ê–ù–ò–ï –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –¥–∞–∂–µ –µ—Å–ª–∏ —Ç—ã —Ç–∞–∫–∂–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—à—å —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –∏–ª–∏ SPEAK!/IMAGE JSON ‚Äî showroad JSON –¥–æ–ª–∂–µ–Ω –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –û–¢–î–ï–õ–¨–ù–´–ú –±–ª–æ–∫–æ–º. –ù–µ –¥–æ–±–∞–≤–ª—è–π —Ç—É–¥–∞ –Ω–∏–∫–∞–∫–∏—Ö –¥—Ä—É–≥–∏—Ö –∫–ª—é—á–µ–π, —Ç–æ–ª—å–∫–æ {{"showroad": true}}.

–û—Ç–≤–µ—Ç—å –∫–∞–∫ –æ–ø—ã—Ç–Ω—ã–π —Å–æ—Ç—Ä—É–¥–Ω–∏–∫ –∫–æ–º–ø–∞–Ω–∏–∏ –ò–ö–ê–† - –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –∏ –ø–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É. –ò—Å–ø–æ–ª—å–∑—É–π –ø–∞–º—è—Ç—å —É–º–Ω–æ, –Ω–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É —Ç–µ–∫—É—â–µ–≥–æ —Ä–∞–∑–≥–æ–≤–æ—Ä–∞. –ú–æ–∂–µ—à—å –ø–æ–º–æ—á—å —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏, –∫–∞—Å—Å–æ–≤–æ–π —Ç–µ—Ö–Ω–∏–∫–µ, 1–°, –°–ë–ò–°, –≠–í–û–¢–û–†, –ê–¢–û–õ, –ï–ì–ê–ò–°, –ß–ï–°–¢–ù–´–ô –ó–ù–ê–ö."""
    
    # –°–æ–∑–¥–∞—ë–º memory injector –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ —Ç–æ–∫–µ–Ω–æ–≤
    memory_injector = MemoryInjector()
    
    # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —Ç–æ–∫–µ–Ω—ã
    system_tokens = memory_injector.count_tokens(system_prompt)
    user_tokens = memory_injector.count_tokens(user_message)
    total_tokens = system_tokens + user_tokens
    
    # –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
    print("üîç –ê–ù–ê–õ–ò–ó –¢–û–ö–ï–ù–û–í –í –ü–†–û–ú–ü–¢–ê–•")
    print("=" * 50)
    print(f"üìù –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç: {system_tokens:,} —Ç–æ–∫–µ–Ω–æ–≤")
    print(f"üí¨ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç: {user_tokens:,} —Ç–æ–∫–µ–Ω–æ–≤")
    print(f"üìä –û–ë–©–ò–ô –†–ê–ó–ú–ï–†: {total_tokens:,} —Ç–æ–∫–µ–Ω–æ–≤")
    print()
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤ —Å–∏–º–≤–æ–ª–∞—Ö
    system_chars = len(system_prompt)
    user_chars = len(user_message)
    total_chars = system_chars + user_chars
    
    print("üìè –†–ê–ó–ú–ï–†–´ –í –°–ò–ú–í–û–õ–ê–•:")
    print(f"üìù –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç: {system_chars:,} —Å–∏–º–≤–æ–ª–æ–≤")
    print(f"üí¨ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç: {user_chars:,} —Å–∏–º–≤–æ–ª–æ–≤")
    print(f"üìä –û–ë–©–ò–ô –†–ê–ó–ú–ï–†: {total_chars:,} —Å–∏–º–≤–æ–ª–æ–≤")
    print()
    
    # –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –∫ —Å–∏–º–≤–æ–ª–∞–º
    system_ratio = system_tokens / system_chars if system_chars > 0 else 0
    user_ratio = user_tokens / user_chars if user_chars > 0 else 0
    total_ratio = total_tokens / total_chars if total_chars > 0 else 0
    
    print("üìà –°–û–û–¢–ù–û–®–ï–ù–ò–ï –¢–û–ö–ï–ù–´/–°–ò–ú–í–û–õ–´:")
    print(f"üìù –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç: {system_ratio:.3f}")
    print(f"üí¨ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—Ä–æ–º–ø—Ç: {user_ratio:.3f}")
    print(f"üìä –û–ë–©–ò–ô: {total_ratio:.3f}")
    print()
    
    # –û—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ (–ø—Ä–∏–º–µ—Ä–Ω–∞—è)
    print("üí∞ –ü–†–ò–ú–ï–†–ù–ê–Ø –°–¢–û–ò–ú–û–°–¢–¨ (OpenRouter):")
    print(f"üìä –í—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã: {total_tokens:,} √ó $0.0001 = ${total_tokens * 0.0001:.4f}")
    print(f"üì§ –í—ã—Ö–æ–¥–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã (–ø—Ä–∏–º–µ—Ä–Ω–æ 500): 500 √ó $0.0003 = $0.1500")
    print(f"üí∏ –û–ë–©–ê–Ø –°–¢–û–ò–ú–û–°–¢–¨: ~${(total_tokens * 0.0001) + 0.15:.4f}")
    print()
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–º–ø—Ç—ã –≤ —Ñ–∞–π–ª –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    filename = f"/root/IKAR-ASSISTANT/prompt_analysis_{timestamp}.json"
    
    analysis_data = {
        "timestamp": timestamp,
        "system_prompt": system_prompt,
        "user_prompt": user_message,
        "tokens": {
            "system": system_tokens,
            "user": user_tokens,
            "total": total_tokens
        },
        "characters": {
            "system": system_chars,
            "user": user_chars,
            "total": total_chars
        },
        "ratios": {
            "system": system_ratio,
            "user": user_ratio,
            "total": total_ratio
        }
    }
    
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(analysis_data, f, ensure_ascii=False, indent=2)
    
    print(f"üíæ –ê–Ω–∞–ª–∏–∑ —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤: {filename}")

if __name__ == "__main__":
    asyncio.run(test_prompt_tokens())
