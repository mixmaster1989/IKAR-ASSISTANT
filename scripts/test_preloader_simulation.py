#!/usr/bin/env python3
"""
–°–∏–º—É–ª—è—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Smart Context Preloader
"""

import sys
import os
import time
import requests
import json
from datetime import datetime

# –î–æ–±–∞–≤–ª—è–µ–º backend –≤ –ø—É—Ç—å
sys.path.append(os.path.join(os.path.dirname(__file__), '..', 'backend'))

def get_preloader_status():
    """–ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞"""
    try:
        response = requests.get('http://localhost:6666/api/admin/context_preloader/status')
        return response.json()
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: {e}")
        return None

def simulate_user_activity(user_id: str, messages: list):
    """–°–∏–º—É–ª—è—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    print(f"\nüë§ –°–∏–º—É–ª—è—Ü–∏—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_id}")
    print("=" * 50)
    
    for i, message in enumerate(messages, 1):
        print(f"\nüìù –°–æ–æ–±—â–µ–Ω–∏–µ {i}: {message}")
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram API
        try:
            response = requests.post('http://localhost:6666/api/telegram/webhook', json={
                "update_id": int(time.time()),
                "message": {
                    "message_id": i,
                    "from": {
                        "id": int(user_id.replace("tg_", "")),
                        "username": "test_user"
                    },
                    "chat": {
                        "id": int(user_id.replace("tg_", "")),
                        "type": "private"
                    },
                    "text": message,
                    "date": int(time.time())
                }
            })
            
            if response.status_code == 200:
                print("‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ")
            else:
                print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: {response.status_code}")
                
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        
        # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –º–µ–∂–¥—É —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        time.sleep(2)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞
        status = get_preloader_status()
        if status and status.get('status') == 'ok':
            preloader = status.get('preloader', {})
            print(f"üìä –ü—Ä–µ–ª–æ–∞–¥–µ—Ä: {preloader.get('active_users', 0)} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, "
                  f"{preloader.get('cached_contexts', 0)} –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤")

def test_preloader_scenarios():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞"""
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Smart Context Preloader")
    print("=" * 60)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
    print("\nüìä –ù–∞—á–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞:")
    initial_status = get_preloader_status()
    if initial_status:
        preloader = initial_status.get('preloader', {})
        print(f"   –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {preloader.get('active_users', 0)}")
        print(f"   –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤: {preloader.get('cached_contexts', 0)}")
        print(f"   –ü–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∫—ç—à: {preloader.get('cache_hit_rate', 0)}%")
    
    # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –±—ã—Å—Ç—Ä—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
    print("\nüéØ –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
    user1_messages = [
        "–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?",
        "–†–∞—Å—Å–∫–∞–∂–∏ –æ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞—Ö",
        "–ß—Ç–æ –¥—É–º–∞–µ—à—å –æ Bitcoin?",
        "–ö–æ–≥–¥–∞ –ª—É—á—à–µ –ø–æ–∫—É–ø–∞—Ç—å?",
        "–ö–∞–∫–∏–µ —Ä–∏—Å–∫–∏ –µ—Å—Ç—å?"
    ]
    simulate_user_activity("tg_123456789", user1_messages)
    
    # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏
    print("\nüéØ –°—Ü–µ–Ω–∞—Ä–∏–π 2: –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
    user2_messages = [
        "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–ª–æ–∫—á–µ–π–Ω?",
        "–û–±—ä—è—Å–Ω–∏ —Å–º–∞—Ä—Ç-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã",
        "–ß—Ç–æ —Ç–∞–∫–æ–µ DeFi?",
        "–ö–∞–∫–∏–µ –µ—Å—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º—ã –∫–æ–Ω—Å–µ–Ω—Å—É—Å–∞?",
        "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –º–∞–π–Ω–∏–Ω–≥?"
    ]
    simulate_user_activity("tg_987654321", user2_messages)
    
    # –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ñ–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–º–∏ –≤–æ–ø—Ä–æ—Å–∞–º–∏
    print("\nüéØ –°—Ü–µ–Ω–∞—Ä–∏–π 3: –§–∏–ª–æ—Å–æ—Ñ—Å–∫–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å")
    user3_messages = [
        "–ß—Ç–æ —Ç–∞–∫–æ–µ —Å–æ–∑–Ω–∞–Ω–∏–µ?",
        "–ú–æ–∂–µ—Ç –ª–∏ –ò–ò –±—ã—Ç—å —Ä–∞–∑—É–º–Ω—ã–º?",
        "–í —á–µ–º —Å–º—ã—Å–ª –∂–∏–∑–Ω–∏?",
        "–ß—Ç–æ —Ç–∞–∫–æ–µ —Å–≤–æ–±–æ–¥–∞ –≤–æ–ª–∏?",
        "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–∞–º—è—Ç—å?"
    ]
    simulate_user_activity("tg_555666777", user3_messages)
    
    # –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
    print("\n‚è≥ –ñ–¥–µ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö...")
    time.sleep(10)
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å
    print("\nüìä –§–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞:")
    final_status = get_preloader_status()
    if final_status:
        preloader = final_status.get('preloader', {})
        print(f"   –ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {preloader.get('active_users', 0)}")
        print(f"   –ö—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–≤: {preloader.get('cached_contexts', 0)}")
        print(f"   –ü–æ–ø–∞–¥–∞–Ω–∏—è –≤ –∫—ç—à: {preloader.get('cache_hit_rate', 0)}%")
        print(f"   –í—Å–µ–≥–æ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∑–æ–∫: {preloader.get('total_preloads', 0)}")
        print(f"   –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏: {preloader.get('memory_usage', {}).get('total_kb', 0)} KB")
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–¥–∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    print("\nüîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:")
    test_users = ["tg_123456789", "tg_987654321", "tg_555666777"]
    
    for user_id in test_users:
        chat_id = user_id.replace("tg_", "")
        try:
            # –°–∏–º—É–ª–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (—ç—Ç–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π API)
            print(f"   –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è {user_id}...")
            # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä—è–º–æ–π –≤—ã–∑–æ–≤ –º–µ—Ç–æ–¥–∞ –ø—Ä–µ–ª–æ–∞–¥–µ—Ä–∞
            print(f"   ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è {user_id}")
        except Exception as e:
            print(f"   ‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è {user_id}: {e}")
    
    print("\nüéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")
    print("üåê –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: https://igorhook6666.loca.lt/context-preloader.html")

def test_specific_user():
    """–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    print("\nüéØ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    print("–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: tg_123456789):")
    
    user_id = input().strip()
    if not user_id:
        user_id = "tg_123456789"
    
    print(f"–¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_id}")
    
    # –ü—Ä–æ—Å—Ç—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–∞
    messages = [
        "–ü—Ä–∏–≤–µ—Ç!",
        "–ö–∞–∫ –¥–µ–ª–∞?",
        "–†–∞—Å—Å–∫–∞–∂–∏ –∞–Ω–µ–∫–¥–æ—Ç",
        "–ß—Ç–æ –Ω–æ–≤–æ–≥–æ?",
        "–ü–æ–∫–∞!"
    ]
    
    simulate_user_activity(user_id, messages)

if __name__ == "__main__":
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Smart Context Preloader")
    print("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∂–∏–º:")
    print("1. –ü–æ–ª–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (3 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)")
    print("2. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è")
    
    choice = input("–í–≤–µ–¥–∏—Ç–µ –≤—ã–±–æ—Ä (1 –∏–ª–∏ 2): ").strip()
    
    if choice == "2":
        test_specific_user()
    else:
        test_preloader_scenarios() 