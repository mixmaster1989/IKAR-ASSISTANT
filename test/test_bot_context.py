#!/usr/bin/env python3
"""
üß™ –¢–µ—Å—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Ç—Ä–∏–≥–≥–µ—Ä–∞ "–±–æ—Ç"
–î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç, –∫–∞–∫ –±–æ—Ç –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –≥—Ä—É–ø–ø—ã –∏ –æ—Ç–≤–µ—á–∞–µ—Ç —É–º–µ—Å—Ç–Ω–æ
"""

import asyncio
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ backend
sys.path.append(os.path.join(os.path.dirname(__file__), 'backend'))

from api.group_bot_trigger import process_bot_trigger
from memory.sqlite import SQLiteStorage

async def test_bot_context():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Ç—Ä–∏–≥–≥–µ—Ä–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –≥—Ä—É–ø–ø—ã"""
    
    print("üß™ –¢–ï–°–¢ –ö–û–ù–¢–ï–ö–°–¢–ù–û–ô –†–ê–ë–û–¢–´ –¢–†–ò–ì–ì–ï–†–ê '–ë–û–¢'")
    print("=" * 50)
    
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    sqlite_storage = SQLiteStorage()
    
    # –¢–µ—Å—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞
    chat_id = "test_group_context"
    user_id = "test_user_456"
    
    print(f"üìù –¢–µ—Å—Ç–æ–≤–∞—è –≥—Ä—É–ø–ø–∞: {chat_id}")
    print(f"üë§ –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id}")
    print()
    
    # –°–∏–º—É–ª–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
    print("üí¨ –°–∏–º—É–ª–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ä–∞–∑–≥–æ–≤–æ—Ä–∞ –≤ –≥—Ä—É–ø–ø–µ:")
    print("-" * 40)
    
    # –°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    context_messages = [
        ("user_1", "–ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º! –ö–∞–∫ –¥–µ–ª–∞?"),
        ("user_2", "–ü—Ä–∏–≤–µ—Ç! –í—Å–µ —Ö–æ—Ä–æ—à–æ, —Ä–∞–±–æ—Ç–∞—é –Ω–∞–¥ –ø—Ä–æ–µ–∫—Ç–æ–º"),
        ("user_1", "–ö–∞–∫–æ–π –ø—Ä–æ–µ–∫—Ç?"),
        ("user_2", "–î–µ–ª–∞—é –±–æ—Ç–∞ –¥–ª—è Telegram, –Ω–æ —á—Ç–æ-—Ç–æ –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è"),
        ("user_3", "–ê —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?"),
        ("user_2", "–ù–µ –º–æ–≥—É –ø–æ–Ω—è—Ç—å, –ø–æ—á–µ–º—É –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è"),
        ("user_1", "–ú–æ–∂–µ—Ç, –ø—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–∫–µ–Ω–µ?"),
        ("user_2", "–¢–æ–∫–µ–Ω –ø—Ä–æ–≤–µ—Ä–∏–ª, –≤—Å–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ"),
        ("user_3", "–ü–æ–∫–∞–∂–∏ –∫–æ–¥, –º–æ–∂–µ—Ç –Ω–∞–π–¥–µ–º –æ—à–∏–±–∫—É"),
        ("user_2", "–•–æ—Ä–æ—à–æ, —Å–µ–π—á–∞—Å –ø–æ–∫–∞–∂—É"),
    ]
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–∞–∑—É
    for i, (msg_user_id, content) in enumerate(context_messages):
        sqlite_storage.save_group_message(
            chat_id=chat_id,
            message_id=i + 1,
            user_id=msg_user_id,
            msg_type="text",
            content=content,
            timestamp=1700000000 + i * 60  # –ö–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É
        )
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        sqlite_storage.set_group_user_name(chat_id, msg_user_id, f"User_{msg_user_id}")
        
        print(f"üë§ User_{msg_user_id}: {content}")
    
    print()
    print("ü§ñ –¢–µ–ø–µ—Ä—å –∫—Ç–æ-—Ç–æ –ø–∏—à–µ—Ç '–±–æ—Ç':")
    print("-" * 40)
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ç—Ä–∏–≥–≥–µ—Ä —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º
    try:
        response = await process_bot_trigger(chat_id, "–±–æ—Ç", user_id)
        
        print(f"üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: –±–æ—Ç")
        print(f"ü§ñ –ë–æ—Ç: {response}")
        
        print()
        print("‚úÖ –¢–µ—Å—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω!")
        print()
        print("üìä –ê–Ω–∞–ª–∏–∑ –æ—Ç–≤–µ—Ç–∞:")
        print("-" * 20)
        
        # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
        if "–∫–æ–¥" in response.lower() or "–ø—Ä–æ–µ–∫—Ç" in response.lower() or "–±–æ—Ç" in response.lower():
            print("‚úÖ –ë–æ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–Ω—è–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç - –æ–±—Å—É–∂–¥–∞–µ—Ç—Å—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –±–æ—Ç–∞")
        else:
            print("‚ö†Ô∏è –ë–æ—Ç –Ω–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–Ω—è–ª –∫–æ–Ω—Ç–µ–∫—Å—Ç")
            
        if "–ø–æ–º–æ—á—å" in response.lower() or "–ø–æ–º–æ–∂–µ–º" in response.lower():
            print("‚úÖ –ë–æ—Ç –ø—Ä–µ–¥–ª–æ–∂–∏–ª –ø–æ–º–æ—â—å - —ç—Ç–æ —Ö–æ—Ä–æ—à–æ")
        else:
            print("‚ö†Ô∏è –ë–æ—Ç –Ω–µ –ø—Ä–µ–¥–ª–æ–∂–∏–ª –ø–æ–º–æ—â—å")
            
        if "ü§ñ" in response or "üíª" in response or "üîß" in response:
            print("‚úÖ –ë–æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —ç–º–æ–¥–∑–∏ - —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è —Ö–æ—Ä–æ—à–∏–π")
        else:
            print("‚ö†Ô∏è –ë–æ—Ç –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª —ç–º–æ–¥–∑–∏")
            
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: {e}")
    
    print()
    print("üßπ –û—á–∏—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ...")
    
    # –û—á–∏—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    try:
        import sqlite3
        conn = sqlite3.connect(sqlite_storage.db_path)
        cursor = conn.cursor()
        
        # –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        cursor.execute('DELETE FROM group_history WHERE chat_id = ?', (chat_id,))
        
        # –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –∏–º–µ–Ω–∞
        cursor.execute('DELETE FROM group_user_names WHERE chat_id = ?', (chat_id,))
        
        conn.commit()
        conn.close()
        
        print("‚úÖ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã")
        
    except Exception as e:
        print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")

if __name__ == "__main__":
    asyncio.run(test_bot_context()) 