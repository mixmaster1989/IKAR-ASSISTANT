#!/usr/bin/env python3
"""
üß™ –¢–µ—Å—Ç –≥—Ä—É–ø–ø–æ–≤–æ–≥–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞ "–±–æ—Ç"
–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Å–ª–æ–≤–∞ "–±–æ—Ç"
"""

import asyncio
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ backend
sys.path.append(os.path.join(os.path.dirname(__file__), 'backend'))

from api.group_bot_trigger import GroupBotTrigger

async def test_bot_trigger():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É —Ç—Ä–∏–≥–≥–µ—Ä–∞ '–±–æ—Ç'"""
    
    print("üß™ –¢–ï–°–¢ –¢–†–ò–ì–ì–ï–†–ê '–ë–û–¢'")
    print("=" * 50)
    
    # –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä —Ç—Ä–∏–≥–≥–µ—Ä–∞
    trigger = GroupBotTrigger()
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    test_messages = [
        # –î–æ–ª–∂–Ω—ã —Å—Ä–∞–±–æ—Ç–∞—Ç—å (—Ç–æ—á–Ω–æ–µ —Å–ª–æ–≤–æ "–±–æ—Ç")
        ("–±–æ—Ç", True, "–¢–æ—á–Ω–æ–µ —Å–ª–æ–≤–æ '–±–æ—Ç'"),
        ("–ë–û–¢", True, "–¢–æ—á–Ω–æ–µ —Å–ª–æ–≤–æ '–ë–û–¢' (–∑–∞–≥–ª–∞–≤–Ω—ã–µ)"),
        ("–ë–æ—Ç", True, "–¢–æ—á–Ω–æ–µ —Å–ª–æ–≤–æ '–ë–æ—Ç' (—Å –∑–∞–≥–ª–∞–≤–Ω–æ–π)"),
        ("–ü—Ä–∏–≤–µ—Ç, –±–æ—Ç!", True, "–°–ª–æ–≤–æ '–±–æ—Ç' –≤ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–∏"),
        ("–±–æ—Ç, –∫–∞–∫ –¥–µ–ª–∞?", True, "–°–ª–æ–≤–æ '–±–æ—Ç' –≤ –Ω–∞—á–∞–ª–µ"),
        ("–ö–∞–∫ –¥–µ–ª–∞, –±–æ—Ç?", True, "–°–ª–æ–≤–æ '–±–æ—Ç' –≤ –∫–æ–Ω—Ü–µ"),
        ("–≠—Ç–æ –±–æ—Ç.", True, "–°–ª–æ–≤–æ '–±–æ—Ç' —Å —Ç–æ—á–∫–æ–π"),
        ("–±–æ—Ç,", True, "–°–ª–æ–≤–æ '–±–æ—Ç' —Å –∑–∞–ø—è—Ç–æ–π"),
        ("–±–æ—Ç!", True, "–°–ª–æ–≤–æ '–±–æ—Ç' —Å –≤–æ—Å–∫–ª–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º –∑–Ω–∞–∫–æ–º"),
        
        # –ù–ï –¥–æ–ª–∂–Ω—ã —Å—Ä–∞–±–æ—Ç–∞—Ç—å (—á–∞—Å—Ç–∏ –¥—Ä—É–≥–∏—Ö —Å–ª–æ–≤)
        ("—Ä–∞–±–æ—Ç–∞–µ—Ç", False, "–ß–∞—Å—Ç—å —Å–ª–æ–≤–∞ '—Ä–∞–±–æ—Ç–∞–µ—Ç'"),
        ("—Ä–æ–±–æ—Ç", False, "–ß–∞—Å—Ç—å —Å–ª–æ–≤–∞ '—Ä–æ–±–æ—Ç'"),
        ("–±–æ—Ç–æ–≤–æ–¥", False, "–ß–∞—Å—Ç—å —Å–ª–æ–≤–∞ '–±–æ—Ç–æ–≤–æ–¥'"),
        ("–±–æ—Ç–æ–∫—Å", False, "–ß–∞—Å—Ç—å —Å–ª–æ–≤–∞ '–±–æ—Ç–æ–∫—Å'"),
        ("–±–æ—Ç–≤–∞", False, "–ß–∞—Å—Ç—å —Å–ª–æ–≤–∞ '–±–æ—Ç–≤–∞'"),
        ("–±–æ—Ç—ã", False, "–ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ '–±–æ—Ç—ã'"),
        ("–±–æ—Ç–∞", False, "–†–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂ '–±–æ—Ç–∞'"),
        ("–±–æ—Ç—É", False, "–î–∞—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂ '–±–æ—Ç—É'"),
        ("–±–æ—Ç–æ–º", False, "–¢–≤–æ—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø–∞–¥–µ–∂ '–±–æ—Ç–æ–º'"),
        ("–±–æ—Ç–µ", False, "–ü—Ä–µ–¥–ª–æ–∂–Ω—ã–π –ø–∞–¥–µ–∂ '–±–æ—Ç–µ'"),
        
        # –ü—É—Å—Ç—ã–µ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏
        ("", False, "–ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"),
        ("–ø—Ä–∏–≤–µ—Ç", False, "–û–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–µ–∑ '–±–æ—Ç'"),
        ("123", False, "–¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã"),
        ("!@#$%", False, "–¢–æ–ª—å–∫–æ —Å–∏–º–≤–æ–ª—ã"),
    ]
    
    print("üìã –¢–µ—Å—Ç–∏—Ä—É–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Å–ª–æ–≤–∞ '–±–æ—Ç':")
    print("-" * 50)
    
    passed = 0
    failed = 0
    
    for message, expected, description in test_messages:
        result = trigger.is_triggered(message)
        status = "‚úÖ –ü–†–û–®–ï–õ" if result == expected else "‚ùå –ü–†–û–í–ê–õ"
        
        print(f"{status} | '{message}' | {description}")
        print(f"   –û–∂–∏–¥–∞–ª–æ—Å—å: {expected}, –ü–æ–ª—É—á–µ–Ω–æ: {result}")
        
        if result == expected:
            passed += 1
        else:
            failed += 1
    
    print("-" * 50)
    print(f"üìä –†–ï–ó–£–õ–¨–¢–ê–¢: {passed} –ø—Ä–æ—à–ª–æ, {failed} –ø—Ä–æ–≤–∞–ª–∏–ª–æ—Å—å")
    
    # –¢–µ—Å—Ç cooldown
    print("\n‚è∞ –¢–µ—Å—Ç–∏—Ä—É–µ–º cooldown:")
    print("-" * 30)
    
    chat_id = "test_chat_123"
    
    # –ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤ - –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–±–æ—Ç–∞—Ç—å
    result1 = await trigger.process_trigger(chat_id, "–±–æ—Ç", "user1")
    print(f"–ü–µ—Ä–≤—ã–π –≤—ã–∑–æ–≤: {result1}")
    
    # –í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ —Å—Ä–∞–∑—É - –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å cooldown
    result2 = await trigger.process_trigger(chat_id, "–±–æ—Ç", "user2")
    print(f"–í—Ç–æ—Ä–æ–π –≤—ã–∑–æ–≤ (cooldown): {result2}")
    
    # –¢–µ—Å—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    print("\nüìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–∏–≥–≥–µ—Ä–∞:")
    print("-" * 30)
    stats = trigger.get_stats()
    print(f"–ê–∫—Ç–∏–≤–Ω—ã—Ö —á–∞—Ç–æ–≤: {stats['active_chats']}")
    print(f"Cooldown (—Å–µ–∫): {stats['cooldown_seconds']}")
    print(f"–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–∏–≥–≥–µ—Ä—ã: {stats['last_triggers']}")
    
    print("\nüéâ –¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω!")

if __name__ == "__main__":
    asyncio.run(test_bot_trigger()) 