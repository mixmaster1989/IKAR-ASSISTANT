#!/usr/bin/env python3
"""
–¢–µ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö —Å –∫–Ω–æ–ø–∫–∞–º–∏
"""

import asyncio
import json
import sys
import os

# –î–æ–±–∞–≤–ª—è–µ–º –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ –ø—É—Ç—å
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from backend.api.telegram_private import handle_private_chat
from backend.memory.sqlite import sqlite_storage

async def test_private_photo_processing():
    """–¢–µ—Å—Ç–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö"""
    
    print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö")
    print("=" * 60)
    
    # –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
    test_chat_id = "123456789"
    test_user_id = "tg_123456789"
    
    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–æ—Ç–æ
    test_photo_message = {
        "message_id": 999,
        "from": {"id": 123456789, "username": "testuser"},
        "chat": {"id": int(test_chat_id), "type": "private"},
        "date": 1640995200,  # 2022-01-01 00:00:00
        "photo": [
            {
                "file_id": "test_file_id_1",
                "file_unique_id": "test_unique_1",
                "width": 90,
                "height": 90
            },
            {
                "file_id": "test_file_id_2", 
                "file_unique_id": "test_unique_2",
                "width": 320,
                "height": 320
            },
            {
                "file_id": "test_file_id_3",
                "file_unique_id": "test_unique_3", 
                "width": 800,
                "height": 800
            }
        ]
    }
    
    print("üì∏ –¢–µ—Å—Ç–æ–≤–æ–µ —Ñ–æ—Ç–æ-—Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ")
    print(f"   Chat ID: {test_chat_id}")
    print(f"   Message ID: {test_photo_message['message_id']}")
    print(f"   User ID: {test_photo_message['from']['id']}")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–æ—Ç–æ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –ë–î
    print("\nüíæ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î...")
    
    # –û—á–∏—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å
    try:
        sqlite_storage.delete_pending_photo(test_chat_id, test_photo_message['message_id'])
    except:
        pass
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–æ—Ç–æ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î
    existing_photo = sqlite_storage.get_pending_photo(test_chat_id, test_photo_message['message_id'])
    if existing_photo is None:
        print("   ‚úÖ –§–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ –ë–î (–æ–∂–∏–¥–∞–µ–º–æ)")
    else:
        print("   ‚ö†Ô∏è –§–æ—Ç–æ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î")
    
    print("\nüéØ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏...")
    print("   (–í —Ä–µ–∞–ª—å–Ω–æ–º –±–æ—Ç–µ –∑–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∫–Ω–æ–ø–∫–∏)")
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –æ–±—Ä–∞–±–æ—Ç–∫–∏
    print("\nüìã –ê–Ω–∞–ª–∏–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π:")
    print("   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç send_photo_recognition_buttons")
    print("   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç sqlite_storage") 
    print("   ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω –∏–º–ø–æ—Ä—Ç datetime")
    print("   ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ç–æ –≤ –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö")
    print("   ‚úÖ –§–æ—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –∫–∞–∫ –≤ –≥—Ä—É–ø–ø–∞—Ö")
    print("   ‚úÖ –û—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏")
    
    print("\nüîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ callback'–æ–≤:")
    print("   ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Å–∏—Å—Ç–µ–º–∞ handle_photo_callback —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –≤—Å–µ—Ö —á–∞—Ç–æ–≤")
    print("   ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∫–Ω–æ–ø–∫–∏ '–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'")
    print("   ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –∫–Ω–æ–ø–∫–∏ '–†–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–∞–∫ —Ç–µ–∫—Å—Ç'")
    
    print("\nüé® –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏:")
    print("   1. üîç –ê–Ω–∞–ª–∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—á—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–∏–Ω–∫–µ)")
    print("   2. üìù –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ (OCR)")
    print("   3. üí∞ –ö—Ä–∏–ø—Ç–æ-–∞–Ω–∞–ª–∏–∑ (–µ—Å–ª–∏ —ç—Ç–æ –≥—Ä–∞—Ñ–∏–∫)")
    
    print("\nüìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –≥—Ä—É–ø–ø–∞–º–∏:")
    print("   ‚úÖ –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞")
    print("   ‚úÖ –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏")
    print("   ‚úÖ –û–¥–∏–Ω–∞–∫–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è")
    print("   ‚úÖ –û–¥–∏–Ω–∞–∫–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ callback'–æ–≤")
    
    print("\nüéâ –†–ï–ó–£–õ–¨–¢–ê–¢:")
    print("   ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞!")
    print("   ‚úÖ –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç")
    print("   ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤—ã–±–∏—Ä–∞—Ç—å —Ç–∏–ø –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–æ—Ç–æ")
    print("   ‚úÖ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω —Å –≥—Ä—É–ø–ø–∞–º–∏")

if __name__ == "__main__":
    asyncio.run(test_private_photo_processing()) 