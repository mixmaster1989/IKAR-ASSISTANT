# üîí –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –£–¢–ï–ß–ö–ò –ü–ê–ú–Ø–¢–ò –ú–ï–ñ–î–£ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø–ú–ò

## üö® **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ë–ê–ì**

–°–∏—Å—Ç–µ–º–∞ –ø–∞–º—è—Ç–∏ –Ω–µ –ø–µ—Ä—Å–æ–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª–∞ –¥–∞–Ω–Ω—ã–µ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—É—é –ø–∞–º—è—Ç—å –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ **—É—Ç–µ—á–∫–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –∏ –≥—Ä—É–ø–ø–∞–º–∏.

### **–ü—Ä–æ–±–ª–µ–º–∞**:
- –ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å –∏–Ω—ä–µ–∫—Ç–∏—Ä–æ–≤–∞–ª–∞—Å—å –í–°–ï–ú –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤–∏–¥–µ–ª–∏ —á—É–∂–∏–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
- –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏
- –ù–µ—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å —á—É–∂–∏–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º

## ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–ò–ï**

### **1. Memory Injector** (`backend/core/memory_injector.py`)

**–ë—ã–ª–æ**:
```python
async def select_relevant_memories(self, query: str, context: str, max_memories: int = 10):
    # –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º
    for keyword in query_keywords[:5]:
        memories = await self.collective_mind.get_collective_wisdom(keyword, limit=20)
        all_memories.extend(memories)  # –í–°–ï –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –¥–ª—è –í–°–ï–•
```

**–°—Ç–∞–ª–æ**:
```python
async def select_relevant_memories(self, query: str, context: str, user_id: str = None, max_memories: int = 10):
    # üîí –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
    if user_id:
        # –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –≤ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        personal_memories = await vector_store.search_memories(query, user_id, limit=10)
        for memory in personal_memories:
            chunk = MemoryChunk(
                content=memory['text'],
                relevance_score=0.8,  # –í—ã—Å–æ–∫–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –ø–∞–º—è—Ç–∏
                memory_type='personal',
                source_agent=user_id,
                importance=0.9,
                tokens_count=self.count_tokens(memory['text']),
                context_tags=[],
                timestamp=memory.get('timestamp', time.time())
            )
            all_memories.append(chunk)
    
    # –ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º –≤ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏ (—Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ –∑–Ω–∞–Ω–∏—è)
    for keyword in query_keywords[:3]:  # –£–º–µ–Ω—å—à–∏–ª–∏ —Å 5 –¥–æ 3
        memories = await self.collective_mind.get_collective_wisdom(keyword, limit=10)  # –£–º–µ–Ω—å—à–∏–ª–∏ —Å 20 –¥–æ 10
        all_memories.extend(memories)
```

### **2. OpenRouter Client** (`backend/llm/openrouter.py`)

**–ë—ã–ª–æ**:
```python
async def generate_response(self, prompt: str, context: str = "", use_memory: bool = True, ...):
    enhanced_prompt = await self.memory_injector.inject_memory_into_prompt(prompt, context, memory_budget)
```

**–°—Ç–∞–ª–æ**:
```python
async def generate_response(self, prompt: str, context: str = "", use_memory: bool = True, user_id: str = None, ...):
    # üîí –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º user_id –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏
    enhanced_prompt = await self.memory_injector.inject_memory_into_prompt(prompt, context, user_id, memory_budget)
```

### **3. Chat Completion** (`backend/llm/openrouter.py`)

**–ë—ã–ª–æ**:
```python
async def chat_completion(self, user_message: str, system_prompt: str = "", chat_history: Optional[List[Dict[str, str]]] = None, context: str = "", **kwargs):
    return await self.generate_response(full_prompt, context=context, **kwargs)
```

**–°—Ç–∞–ª–æ**:
```python
async def chat_completion(self, user_message: str, system_prompt: str = "", chat_history: Optional[List[Dict[str, str]]] = None, context: str = "", user_id: str = None, **kwargs):
    # üîí –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º user_id –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏
    return await self.generate_response(full_prompt, context=context, user_id=user_id, **kwargs)
```

### **4. Telegram Processing** (`backend/api/telegram.py`)

**–ë—ã–ª–æ**:
```python
llm_response = await llm_client.chat_completion(
    user_message=message_text,
    system_prompt=system_prompt,
    chat_history=formatted_history
)
```

**–°—Ç–∞–ª–æ**:
```python
llm_response = await llm_client.chat_completion(
    user_message=message_text,
    system_prompt=system_prompt,
    chat_history=formatted_history,
    user_id=user_id  # üîí –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º user_id –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏
)
```

## üß™ **–¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï**

–°–æ–∑–¥–∞–Ω —Ç–µ—Å—Ç `test/test_memory_isolation.py` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–∑–æ–ª—è—Ü–∏–∏ –ø–∞–º—è—Ç–∏:

```bash
cd test
python test_memory_isolation.py
```

**–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç**:
1. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
2. ‚úÖ –ò–∑–æ–ª—è—Ü–∏—é –ø–æ–∏—Å–∫–∞ - –∫–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è
3. ‚úÖ –†–∞–∑–ª–∏—á–∏—è –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. ‚úÖ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–π –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞—Ö –ø–æ–∏—Å–∫–∞

## üîí **–†–ï–ó–£–õ–¨–¢–ê–¢**

### **–î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
- ‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –≤–∏–¥–µ–ª –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è B
- ‚ùå –ì—Ä—É–ø–ø–æ–≤—ã–µ —á–∞—Ç—ã –ø–æ–ª—É—á–∞–ª–∏ –ª–∏—á–Ω—ã–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è
- ‚ùå –ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å –∏–Ω—ä–µ–∫—Ç–∏—Ä–æ–≤–∞–ª–∞—Å—å –≤—Å–µ–º –±–µ–∑ —Ä–∞–∑–±–æ—Ä–∞
- ‚ùå –ù–∞—Ä—É—à–µ–Ω–∏–µ –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç–∏ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏

### **–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**:
- ‚úÖ –ö–∞–∂–¥—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è
- ‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–π
- ‚úÖ –ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏–π
- ‚úÖ –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –º–µ–∂–¥—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤

## üìä **–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò**

### **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã –ø–∞–º—è—Ç–∏**:
1. **–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å** (relevance_score: 0.8, importance: 0.9)
2. **–ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å** (—Ç–æ–ª—å–∫–æ –æ–±—â–∏–µ –∑–Ω–∞–Ω–∏—è, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –æ–±—ä–µ–º)

### **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è**:
- –ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å: –º–∞–∫—Å–∏–º—É–º 3 –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤–∞, 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å: –º–∞–∫—Å–∏–º—É–º 10 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
- –í—ã—Å–æ–∫–∏–π –ø–æ—Ä–æ–≥ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏: 0.7

### **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**:
- –°—Ç—Ä–æ–≥–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ user_id
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç–∏ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–π
- –ò–∑–æ–ª—è—Ü–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö

## üöÄ **–î–ï–ü–õ–û–ô**

1. **–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤**:
```bash
pm2 restart all
```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤**:
```bash
pm2 logs
```

3. **–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞**:
```bash
cd test && python test_memory_isolation.py
```

## üìù **–õ–û–ì–ò**

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤ –ª–æ–≥–∞—Ö –±—É–¥—É—Ç –≤–∏–¥–Ω—ã:
```
üîí –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º user_id –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–∞–º—è—Ç–∏
‚úÖ –ò–∑–æ–ª—è—Ü–∏—è —Å–æ–±–ª—é–¥–µ–Ω–∞
üß† –ü–∞–º—è—Ç—å –∏–Ω—ä–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∞: X —á–∞–Ω–∫–æ–≤, —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: 0.XX
```

## ‚ö†Ô∏è **–í–ê–ñ–ù–û**

- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ **–æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ** - —Å—Ç–∞—Ä—ã–µ –≤—ã–∑–æ–≤—ã –±–µ–∑ user_id –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å **–Ω–µ —É–¥–∞–ª—è–µ—Ç—Å—è** - –æ–Ω–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏–π
- –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –ø–∞–º—è—Ç—å –∏–º–µ–µ—Ç **–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç** –Ω–∞–¥ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–π
- –í—Å–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ **—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è** 